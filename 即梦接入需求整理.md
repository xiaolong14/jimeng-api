# 即梦接入需求整理文档

## 一、项目背景

### 1.1 业务场景
为AI动漫项目（cartoon项目）设计新的API接口，实现小说转动漫的完整流程。在小说编写好分镜文案后，需要通过描述词生成动漫画面，支持批量分镜同时生成。

### 1.2 核心需求
- **批量生成**：支持批量分镜同时生成图片或视频
- **账号管理**：采用随机分配账号机制，实现账号池管理
- **自动切换**：账号有问题时自动切换账号，实现无感重试
- **详细记录**：完整记录生成过程，便于查看和追踪
- **错误处理**：生成时错误自动无感切换重试

## 二、功能模块

### 2.1 账号管理模块
- **账号池管理**：管理即梦AI账号，支持多站点（cn/us/hk/jp/sg）
- **账号状态跟踪**：跟踪账号状态（正常/停用/封禁）、生图状态、生视频状态
- **额度管理**：记录生成次数，支持额度重置和自动刷新
- **账号分配**：随机分配可用账号，支持优先级调度

### 2.2 图片生成模块
- **文生图**：基于分镜描述词生成图片
- **图生图**：基于已有图片和描述词生成新图片
- **批量生成**：支持批量分镜同时生成
- **记录保存**：详细记录生成参数、状态、结果、错误信息

### 2.3 视频生成模块
- **文生视频**：基于分镜描述词生成视频
- **图生视频**：基于图片和描述词生成视频
- **首尾帧视频**：基于首尾帧图片生成视频
- **批量生成**：支持批量分镜同时生成
- **记录保存**：详细记录生成参数、状态、结果、错误信息

### 2.4 记录查询模块
- **账号查询**：根据创建人分页查询账号列表
- **生成记录查询**：根据创建人、作品ID分页查询生成记录
- **状态追踪**：查询生成状态、错误信息、切换次数等

### 2.5 重新生成模块
- **重新生成**：基于分镜ID重新生成图片或视频
- **覆盖机制**：重新生成时覆盖原本的相应记录
- **参数更新**：支持更新生成参数（模型、提示词、分辨率等）

## 三、数据库表结构

### 3.1 即梦账号管理表（jimeng_accounts）
**用途**：管理即梦AI账号池，支持多站点和生成次数统计

**核心字段**：
- `id`：主键，雪花UUID
- `jimeng_account`：即梦账号
- `jimeng_account_type`：账号类型（0-国内账号，1-国外账号）
- `session_id`：登录状态ID
- `site_type`：站点类型（0-cn，1-us，2-hk，3-jp，4-sg）
- `account_status`：账号状态（0-active，1-inactive，2-banned）
- `image_generation_status`：生图状态（0-不可用，1-可用，2-速率限制）
- `video_generation_status`：生视频状态（0-不可用，1-可用，2-速率限制）
- `image_count`：图片生成次数
- `video_count`：视频生成次数
- `quota_reset_time`：额度重置时间
- `create_by`：创建人
- `update_by`：修改人

### 3.2 图片生成任务记录表（jimeng_image_generation_records）
**用途**：记录图片生成任务，与cartoon项目的作品和分镜建立关联

**核心字段**：
- `id`：主键，雪花UUID
- `jimeng_accounts_id`：即梦账号表ID
- `project_id`：推理项目ID
- `project_name`：推理项目名称
- `storyboard_id`：分镜ID（唯一标识，用于重新生成）
- `work_id`：作品ID
- `model`：使用的模型
- `prompt`：生成提示词
- `generation_status`：生成状态（0-pending，1-processing，2-completed，3-failed，4-retrying）
- `image_urls`：生成图片URL数组
- `error_message`：错误信息
- `site_switch_count`：站点切换次数
- `create_by`：创建人

**唯一约束**：`(project_id, storyboard_id, is_deleted)` - 确保同一分镜在同一项目下只有一条有效记录

### 3.3 视频生成任务记录表（jimeng_video_generation_records）
**用途**：记录视频生成任务，与cartoon项目的作品和分镜建立关联

**核心字段**：
- `id`：主键，雪花UUID
- `jimeng_accounts_id`：即梦账号表ID
- `project_id`：推理项目ID
- `project_name`：推理项目名称
- `storyboard_id`：分镜ID（唯一标识，用于重新生成）
- `work_id`：作品ID
- `model`：使用的模型
- `prompt`：生成提示词
- `generation_status`：生成状态（0-pending，1-processing，2-completed，3-failed，4-retrying）
- `video_urls`：生成视频URL数组
- `error_message`：错误信息
- `site_switch_count`：站点切换次数
- `create_by`：创建人

**唯一约束**：`(project_id, storyboard_id, is_deleted)` - 确保同一分镜在同一项目下只有一条有效记录

## 四、接口设计需求

### 4.1 账号管理接口
- ✅ **创建账号**：批量创建账号，自动设置站点类型和额度重置时间
- ✅ **修改账号**：批量修改账号信息
- ⚠️ **查询账号**：根据创建人分页查询账号列表（需补充）
- ⚠️ **删除账号**：逻辑删除账号（需补充）

### 4.2 图片生成接口
- ✅ **分镜文生图**：基于分镜描述词生成图片，支持批量生成
- ✅ **分镜图生图**：基于图片和描述词生成图片，支持批量生成
- ⚠️ **重新生成图片**：基于分镜ID重新生成，覆盖原记录（需补充）
- ⚠️ **查询生成记录**：根据创建人、作品ID分页查询（需补充）
- ⚠️ **删除生成记录**：逻辑删除生成记录（需补充）

### 4.3 视频生成接口
- ✅ **分镜生视频**：支持文生视频、图生视频、首尾帧视频，支持批量生成
- ⚠️ **重新生成视频**：基于分镜ID重新生成，覆盖原记录（需补充）
- ⚠️ **查询生成记录**：根据创建人、作品ID分页查询（需补充）
- ⚠️ **删除生成记录**：逻辑删除生成记录（需补充）

## 五、核心业务流程

### 5.1 批量生成流程
1. **接收请求**：接收批量分镜生成请求（包含多个分镜的描述词）
2. **账号分配**：从账号池中随机分配可用账号（根据生图/生视频状态）
3. **任务创建**：为每个分镜创建生成任务记录（状态：pending）
4. **异步生成**：调用即梦API进行生成（状态：processing）
5. **账号切换**：如果账号出现问题，自动切换到其他可用账号重试
6. **记录更新**：生成完成后更新记录（状态：completed/failed）
7. **回调通知**：如果提供了回调地址，生成完成后进行回调

### 5.2 重新生成流程
1. **接收请求**：接收重新生成请求（基于分镜ID）
2. **查询原记录**：根据分镜ID查询原生成记录
3. **覆盖更新**：更新原记录的状态为pending，清空原结果
4. **参数更新**：如果提供了新参数，更新生成参数
5. **重新生成**：按照批量生成流程重新生成
6. **记录覆盖**：生成完成后覆盖原记录的结果

### 5.3 账号切换流程
1. **错误检测**：检测到账号错误（速率限制、积分不足、站点不匹配等）
2. **状态更新**：更新账号状态为不可用或速率限制
3. **站点切换**：尝试切换站点（hk → jp → sg）
4. **账号切换**：如果所有站点都不可用，切换到其他账号
5. **重试生成**：使用新账号/站点重新生成
6. **记录更新**：记录站点切换次数和使用的账号

## 六、特殊要求

### 6.1 重新生成机制
- **术语**：生图和视频的修改称之为"重新生成"
- **覆盖方式**：重新生成需要直接基于分镜ID，去覆盖原本的相应记录
- **唯一性**：通过`(project_id, storyboard_id, is_deleted)`唯一约束确保同一分镜只有一条有效记录

### 6.2 查询要求
- **账号查询**：根据创建人（`create_by`）进行分页查询
- **生成记录查询**：根据创建人（`create_by`）和作品ID（`work_id`）进行分页查询
- **分页参数**：支持页码、每页数量、排序等参数

### 6.3 错误处理
- **自动重试**：账号错误时自动切换账号重试，无需用户干预
- **无感切换**：切换过程对用户透明，记录切换次数和原因
- **错误记录**：详细记录错误码、错误信息、切换历史

## 七、接口设计原则

### 7.1 设计原则
- **RESTful风格**：遵循RESTful API设计规范
- **统一响应格式**：所有接口使用统一的响应格式
- **详细文档**：每个接口包含完整的参数、响应、流程、备注说明
- **错误处理**：完善的错误码和错误信息

### 7.2 响应格式
```json
{
  "code": 200,
  "message": "success",
  "data": {},
  "timestamp": 1234567890
}
```

### 7.3 分页格式
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [],
    "total": 100,
    "page": 1,
    "pageSize": 10,
    "totalPages": 10
  }
}
```

## 八、待补充接口清单

### 8.1 查询接口
- [ ] 账号分页查询接口（根据创建人）
- [ ] 图片生成记录分页查询接口（根据创建人、作品ID）
- [ ] 视频生成记录分页查询接口（根据创建人、作品ID）

### 8.2 修改接口
- [ ] 重新生成图片接口（基于分镜ID）
- [ ] 重新生成视频接口（基于分镜ID）

### 8.3 删除接口
- [ ] 删除账号接口（逻辑删除）
- [ ] 删除图片生成记录接口（逻辑删除）
- [ ] 删除视频生成记录接口（逻辑删除）

---

**文档版本**：v1.0  
**创建时间**：2025-01-16  
**最后更新**：2025-01-16

