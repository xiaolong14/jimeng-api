# 项目索引

> 帮助AI快速了解项目结构。极简设计，只包含核心信息，无流程说明。

---

## 1. 项目元信息

```yaml
project:
  name: "jimeng-api"
  type: "monolith"  # 项目类型
  language: "TypeScript"  # 编程语言
  framework: "Koa 2.15.0"  # 框架及版本
  architecture: "Layered"  # 架构模式
  runtime: "Node.js 18+"  # 运行环境
  base_path: "src"  # 基础路径
  last_updated: "2025-12-16"
```

---

## 2. 项目技术架构及简说明

### 技术栈

| 技术类型 | 技术选型 | 版本 | 说明 |
|---------|---------|------|------|
| 运行时 | Node.js | 18+ | JavaScript运行时环境 |
| 编程语言 | TypeScript | 5.3.3 | 类型安全的JavaScript |
| Web框架 | Koa | 2.15.0 | 轻量级Web框架 |
| 路由管理 | koa-router | 12.0.1 | 路由中间件 |
| HTTP客户端 | axios | 1.6.7 | 外部API请求 |
| 表单处理 | form-data | 4.0.0 | 多表单数据处理 |
| 流处理 | eventsource-parser | 1.1.2 | Server-Sent Events |
| 工具库 | lodash | 4.17.21 | JavaScript工具库 |
| 文件操作 | fs-extra | 11.2.0 | 文件系统扩展 |
| 配置解析 | yaml | 2.3.4 | YAML配置文件解析 |
| 唯一标识 | uuid | 9.0.1 | 生成唯一ID |

### 架构说明

```text
【系统分层】
┌─────────────────────────────────┐
│  HTTP Client (OpenAI格式)       │
└───────────┬─────────────────────┘
            │ HTTP/HTTPS
┌───────────▼─────────────────────┐
│  Routes 层（路由层）            │  ← 路由定义、参数接收
└───────────┬─────────────────────┘
            │
┌───────────▼─────────────────────┐
│  Controllers 层（控制器层）      │  ← 业务逻辑、请求处理
└───────────┬─────────────────────┘
            │
┌───────────▼─────────────────────┐
│  Core Services 层（核心服务层）  │  ← 网络请求、文件处理
└───────────┬─────────────────────┘
            │
┌───────────▼─────────────────────┐
│  External APIs (即梦AI/Dreamina) │  ← AI服务提供者
└─────────────────────────────────┘
```

### 核心设计

| 设计方面 | 实现方式 |
|---------|---------|
| 异常处理 | 统一异常处理器（error-handler.ts） |
| 轮询机制 | 智能轮询器（smart-poller.ts），自适应间隔 |
| 日志记录 | 自定义日志系统（logger.ts），文件轮转 |
| 响应格式 | OpenAI API兼容格式 |
| 认证方式 | Bearer Token（基于sessionid） |
| 配置管理 | YAML配置文件，环境变量支持 |

---

## 3. 业务模块索引表

| 业务域 | 功能说明 | Controller | Service | 路由 | 主要文件 |
|--------|--------|-----------|---------|--------|--------|
| 图像生成 | 文生图、图生图功能 | `images.ts` | `images.ts` | `/images` | 图像生成控制器 |
| 视频生成 | 文生视频、图生视频 | `videos.ts` | `videos.ts` | `/videos` | 视频生成控制器 |
| 聊天完成 | 对话式交互、生成图像 | `chat.ts` | `chat.ts` | `/chat` | 聊天完成控制器 |
| 模型管理 | 模型列表、信息查询 | `models.ts` | - | `/models` | 模型列表路由 |
| 健康检查 | 服务状态监控 | `ping.ts` | - | `/ping` | 健康检查路由 |
| 令牌管理 | 访问令牌获取 | `token.ts` | - | `/token` | 令牌路由 |

---

## 4. 支撑组件

### 核心组件（src/lib/）

| 组件名 | 文件路径 | 功能 |
|--------|----------|------|
| 智能轮询器 | `smart-poller.ts` | 自适应轮询间隔，监控任务状态 |
| 异常处理 | `error-handler.ts` | 统一异常处理和错误响应 |
| 日志系统 | `logger.ts` | 结构化日志记录，文件轮转 |
| 图片上传 | `image-uploader.ts` | 图片上传到临时存储 |
| 图片工具 | `image-utils.ts` | 图片格式转换和处理 |
| 区域工具 | `region-utils.ts` | 服务区域选择和切换 |
| AWS签名 | `aws-signature.ts` | AWS签名认证（兼容性） |
| 配置中心 | `config.ts` | 配置文件加载和管理 |
| 环境变量 | `environment.ts` | 环境变量解析和验证 |
| 工具函数 | `util.ts` | 通用工具函数集合 |

### API构建器（src/api/）

| 组件名 | 文件路径 | 功能 |
|--------|----------|------|
| 请求构建器 | `builders/payload-builder.ts` | API请求参数构建 |
| 通用常量 | `consts/common.ts` | 通用常量定义 |
| Dreamina常量 | `consts/dreamina.ts` | Dreamina站点相关常量 |
| 异常常量 | `consts/exceptions.ts` | 异常类型定义 |

### 请求响应处理

| 组件名 | 文件路径 | 功能 |
|--------|----------|------|
| 请求处理 | `request/Request.ts` | HTTP请求封装 |
| 响应处理 | `response/Response.ts` | 响应格式化 |
| 成功响应 | `response/SuccessfulBody.ts` | 成功响应格式 |
| 失败响应 | `response/FailureBody.ts` | 失败响应格式 |

---

## 5. 项目结构

```text
jimeng-api/
├── src/                          # 源代码目录
│   ├── api/                      # API层
│   │   ├── builders/             # 请求构建器
│   │   ├── consts/               # 常量定义
│   │   ├── controllers/          # 控制器
│   │   └── routes/               # 路由定义
│   ├── lib/                      # 核心库
│   │   ├── configs/              # 配置管理
│   │   ├── consts/               # 库常量
│   │   ├── exceptions/           # 异常类
│   │   ├── interfaces/           # 接口定义
│   │   ├── request/              # 请求处理
│   │   ├── response/             # 响应处理
│   │   └── *.ts                  # 核心功能模块
│   ├── daemon.ts                 # 守护进程
│   └── index.ts                  # 入口文件
├── configs/                      # 配置文件
│   └── dev/                      # 开发环境配置
│       ├── service.yml           # 服务配置
│       └── system.yml            # 系统配置
├── dist/                         # 编译输出目录
├── logs/                         # 日志目录
├── tmp/                          # 临时文件目录
├── docker-compose.yml            # Docker编排
├── Dockerfile                    # Docker镜像
├── package.json                  # 项目配置
├── tsconfig.json                 # TypeScript配置
└── README.LWL.md                 # 项目文档
```

---

## 6. AI 快速定位

| 用户意图 | 查询路径 |
|--------|--------|
| "接口"、"API"、"路由" | `src/api/routes/` |
| "控制器"、"业务逻辑" | `src/api/controllers/` |
| "请求构建"、"参数处理" | `src/api/builders/` |
| "核心功能"、"轮询" | `src/lib/smart-poller.ts` |
| "错误"、"异常" | `src/lib/error-handler.ts`, `src/lib/exceptions/` |
| "配置"、"设置" | `src/lib/configs/`, `configs/` |
| "日志"、"记录" | `src/lib/logger.ts` |
| "工具"、"辅助" | `src/lib/util.ts`, `src/lib/image-utils.ts` |
| "常量"、"枚举" | `src/api/consts/`, `src/lib/consts/` |

---

## 7. 命名规范

- **文件命名**：kebab-case 或 camelCase（如：`smart-poller.ts`, `errorHandler.ts`）
- **类命名**：PascalCase（如：`SmartPoller`, `APIException`）
- **函数命名**：camelCase（如：`handleRequest`, `buildPayload`）
- **常量命名**：UPPER_SNAKE_CASE（如：`MAX_RETRIES`, `DEFAULT_TIMEOUT`）
- **路由命名**：kebab-case（如：`/images/generations`, `/videos/completions`）
- **环境变量**：UPPER_SNAKE_CASE（如：`NODE_ENV`, `LOG_LEVEL`）

---

**最后更新**：2025-12-16
**版本**：1.0
