## 开发文档
### 1. 视频测试总结
- **并发限制**：生成视频，图片都似乎不限制并发，一个账号可同时生成多个视频，图片。
- **额度刷新**：一个账号的额度，一天大概能支持两次生成视频，十次生成图片，额度隔天自动刷新。
#### 站点与Session ID说明
国内站 (即梦) 和国际站 获取 `sessionid` 的方法相同。
> **注意1**: 国内站和国际站接口相同，但需要通过不同的前缀来区分：
> - **国内站**：直接使用 `sessionid`，如 `Bearer your_session_id`
> - **美国站**：需要添加 **us-** 前缀，如 `Bearer us-your_session_id`
> - **香港站**：需要添加 **hk-** 前缀，如 `Bearer hk-your_session_id`
> - **日本站**：需要添加 **jp-** 前缀，如 `Bearer jp-your_session_id`
> - **新加坡站**: 需要添加 **sg-** 前缀，如 `Bearer sg-your_session_id`
>
> **注意2**: 国内站和国际站现已同时支持*文生图*和*图生图*。国际站新增 `nanobanana` 和 `nanobananapro` 模型，国内站没有。使用国内IP访问国际站 `nanobanana` 系列模型无法成功生成图片，需开代理。
>
> **注意3**: 国际站使用 `nanobanana` 模型时的分辨率规则:
> - **美国站 (us-)**: 生成的图像固定为 **1024x1024** 和 **2k** 清晰度，忽略用户传入的 `ratio` 和 `resolution` 参数
> - **香港/日本/新加坡站 (hk-/jp-/sg-)**: 强制使用 **1k** 清晰度，但支持自定义 `ratio` 参数（如 16:9、4:3 等）
### 2. 错误码分析
#### 视频生成错误
- **站点不匹配错误**：
    出现下列错误，代表注册账号与请求站点不匹配（国内账号只能用国内站点，国外账号用国外站点）。
    ```json
    {
        "code": -2008,
        "message": "视频生成失败，状态码: 30，错误码: 1500",
        "data": null
    }
    ```
    ```json
    {
        "code": -2002,
        "message": "[登录失效]: check login error。请重新获取refresh_token并更新配置",
        "data": null
    }
    ```
    **解决方案**：将站点依次切换为 `hk`、`jp`、`sg`。直到全部切换尝试都无法完成，才可判定为真正的失败。
- **速率限制错误**：
    出现此响应代表请求彻底失败，是账号速率限制，代表生成视频的次数已消耗殆尽。直接记录为速率限制状态，账号当日不可用，需等到额度刷新。
    ```json
    {
        "code": -2001,
        "message": "[请求失败]: api rate limit (错误码: 1)",
        "data": null
    }
    ```
- **积分不足错误**：
    出现此响应代表请求彻底失败，是账号积分不足以生成视频或图片。直接记录为不可用状态，账号当日不可用，需等到额度刷新。
    ```json
    {
        "code": -2001,
        "message": "[请求失败]: 积分不足 (错误码: 1006)",
        "data": null
    }
    ```

    **解决方案**：请依次切换 `hk`、`jp`、`sg` 站点重试。如果全部切换尝试都无法完成，才可判定为真正的失败，此时生成视频和图片的请求都应记录为不可用状态。
#### 图片生成错误
- **网络请求失败错误**：
    出现下列错误代表请求彻底失败，说明网络有问题。**不要记录失败次数，应进行重试**。
    
    ```json
    {
        "code": -2007,
        "message": "图片上传失败: 图片上传网络请求失败 (tos-d-alisg16-up.byteoversea.com): fetch failed. 请检查网络连接",
        "data": null
    }
    ```
- **速率限制错误**：
    出现此响应代表请求彻底失败，是账号速率限制，一个账号今日的图片生成次数已消耗殆尽。直接记录为速率限制状态，账号当日不可用，需等到额度刷新。
    ```json
    {
        "code": -2001,
        "message": "[请求失败]: api rate limit (错误码: 1)",
        "data": null
    }
    ```
- **账号与站点不匹配错误**：
    出现此错误代表国内账号的 `session_id` 无法请求国外站点的功能，或者国外注册账号无法请求国内站点。
    ```json
    {
        "code": -2001,
        "message": "[请求失败]: invalid parameter (错误码: 1000)",
        "data": null
    }
    ```
    **解决方案**：需要切换站点重试。
### 3. 成功响应示例
#### 文生图生成成功响应
```json
{
    "created": 1765863426,
    "data": [
        {
            "url": "https://p26-dreamina-sign.byteimg.com/tos-cn-i-tb4s082cfz/5980282c36a6408a9f13d2fe4066c0d2~tplv-tb4s082cfz-aigc_resize_mark:0:0.png?lk3s=43402efa&x-expires=1765868400&x-signature=1pTXbo0mxvAFjuVWZrLGlemJYNI%3D&format=.png"
        },
        {
            "url": "https://p26-dreamina-sign.byteimg.com/tos-cn-i-tb4s082cfz/7bed5ae257f54b218e4757b9c8eb0acc~tplv-tb4s082cfz-aigc_resize_mark:0:0.png?lk3s=43402efa&x-expires=1765868400&x-signature=EUXej0rmsahw0Ukl3cCf%2FVl7F2w%3D&format=.png"
        },
        {
            "url": "https://p26-dreamina-sign.byteimg.com/tos-cn-i-tb4s082cfz/ae479c6eb4df4e029181ae42eb8b0546~tplv-tb4s082cfz-aigc_resize_mark:0:0.png?lk3s=43402efa&x-expires=1765868400&x-signature=m36vEf10Oftw3G2dVARD1zg7N54%3D&format=.png"
        },
        {
            "url": "https://p26-dreamina-sign.byteimg.com/tos-cn-i-tb4s082cfz/5ab1e4ad8c1948548739a9085170207e~tplv-tb4s082cfz-aigc_resize_mark:0:0.png?lk3s=43402efa&x-expires=1765868400&x-signature=ATM%2FdAvA3RSHAOVDFMWAmBumRmg%3D&format=.png"
        }
    ]
}
```
---
#### 图生图生成成功响应

```json
{
    "created": 1765881281,
    "data": [
        {
            "url": "https://p16-dreamina-sign-sg.ibyteimg.com/tos-alisg-i-wopfjsm1ax-sg/fb217dd87a714db1b0228bfceba752f2~tplv-wopfjsm1ax-aigc_resize:0:0.jpeg?lk3s=43402efa&x-expires=1767744000&x-signature=BWpfLXZuicQ%2FbSiCgnLnH3OTIDs%3D&format=.jpeg"
        },
        {
            "url": "https://p16-dreamina-sign-sg.ibyteimg.com/tos-alisg-i-wopfjsm1ax-sg/8d7a0ad9dbd64d168f635ca5b894d584~tplv-wopfjsm1ax-aigc_resize:0:0.jpeg?lk3s=43402efa&x-expires=1767744000&x-signature=WmaOXx9QFNDoIKUQEUrLG0qi5qg%3D&format=.jpeg"
        },
        {
            "url": "https://p16-dreamina-sign-sg.ibyteimg.com/tos-alisg-i-wopfjsm1ax-sg/d75b96959e2f47879a58094c324e8230~tplv-wopfjsm1ax-aigc_resize:0:0.jpeg?lk3s=43402efa&x-expires=1767744000&x-signature=G4zs7cPEN6VA0jDt5BalCvYRVAI%3D&format=.jpeg"
        },
        {
            "url": "https://p16-dreamina-sign-sg.ibyteimg.com/tos-alisg-i-wopfjsm1ax-sg/15c4745ab8564fa7ada380cdf0146ee2~tplv-wopfjsm1ax-aigc_resize:0:0.jpeg?lk3s=43402efa&x-expires=1767744000&x-signature=d4fiZt4k48GoLMqGXtsHeQBLoyA%3D&format=.jpeg"
        }
    ],
    "input_images": 1,
    "composition_type": "multi_image_synthesis"
}
```

---

#### 视频生成成功响应

```json
{
    "created": 1765861252,
    "data": [
        {
            "url": "https://v16-cc.capcut.com/1afbbcf38412c8addb5261885b4e91bc/694a220c/video/tos/alisg/tos-alisg-ve-14178-sg/okABiAGfmzeA38YlssqO4IUM53aYXgeAAW5vFf/?a=513641&bti=PDk6QC0yM2A%3D&ch=0&cr=0&dr=0&er=0&cd=0%7C0%7C0%7C0&br=12604&bt=6302&cs=0&ft=GAAO2Inz7ThhQBgPXq8Zmo&mime_type=video_mp4&qs=0&rc=ZTM1Omg6ODpoO2Q6N2dnOkBpamtpZms5cndoODYzODU6NEAuYGBeXzFeNi8xYDM1Li5fYSMwMjNpMmRjYi1hLS1kMy1zcw%3D%3D&vvpl=1&l=20251216130050C11DE4FBFADAE2118029&btag=e000b0000",
            "revised_prompt": "一只奔跑在草原上的狮子"
        }
    ]
}
```

---

### 

### 4. API文档

#### 文生图

**POST** `/v1/images/generations`
**请求参数**:

- `model` (string, 可选): 使用的模型名称。国内站和国际站（US/HK/JP/SG）均默认 `jimeng-4.5`。
- `prompt` (string): 图像描述文本
- `ratio` (string, 可选): 图像比例，默认为 `"1:1"`。支持的比例: `1:1`, `4:3`, `3:4`, `16:9`, `9:16`, `3:2`, `2:3`, `21:9`。**注意**: 当 `intelligent_ratio` 为 `true` 时，此参数将被忽略，系统会根据提示词自动推断最佳比例。
- `resolution` (string, 可选): 分辨率级别，默认为 `"2k"`。支持的分辨率: `1k`, `2k`, `4k`。
- `intelligent_ratio` (boolean, 可选): 是否启用智能比例，默认为 `false`。**⚠️ 此参数仅对 jimeng-4.0/jimeng-4.1/jimeng-4.5 模型有效，其他模型将忽略此参数。** 启用后系统会根据提示词自动推断最佳图像比例（例如："竖屏" → 9:16，"横屏" → 16:9）。
- `negative_prompt` (string, 可选): 负面提示词
- `sample_strength` (number, 可选): 采样强度 (0.0-1.0)
- `response_format` (string, 可选): 响应格式 ("url" 或 "b64_json")
```bash
# 默认参数（ratio: "1:1", resolution: "2k"）
curl -X POST http://localhost:5100/v1/images/generations \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_SESSION_ID" \
  -d '{
    "model": "jimeng-4.5",
    "prompt": "一只可爱的小猫咪"
  }'
# 使用4K分辨率的示例
curl -X POST http://localhost:5100/v1/images/generations \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_SESSION_ID" \
  -d '{
    "model": "jimeng-4.5",
    "prompt": "壮丽的山水风景，超高分辨率",
    "ratio": "16:9",
    "resolution": "4k"
  }'
# 使用智能比例的示例（系统会根据"竖屏"自动推断为9:16）
curl -X POST http://localhost:5100/v1/images/generations \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_SESSION_ID" \
  -d '{
    "model": "jimeng-4.5",
    "prompt": "奔跑的狮子，竖屏",
    "resolution": "2k",
    "intelligent_ratio": true
  }'
```
**支持的模型**:
- `nanobananapro`: 仅国际站支持，支持`ratio` 和`resolution`参数
- `nanobanana`: 仅国际站支持
- `jimeng-4.5`: 国内、国际站均支持，支持 2k/4k 全部 ratio 及 intelligent_ratio **（所有站点默认模型）**
- `jimeng-4.1`: 仅国内站支持，支持 2k/4k 全部 ratio 及 intelligent_ratio
- `jimeng-4.0`: 国内、国际站均支持
- `jimeng-3.1`: 仅国内站支持
- `jimeng-3.0`: 国内、国际站均支持
- `jimeng-2.1`: 仅国内站支持
- `jimeng-xl-pro`
**支持的比例及对应分辨率**：
| resolution  | ratio  | 分辨率    |
| ----------- | ------ | --------- |
| `1k`        | `1:1`  | 1024×1024 |
|             | `4:3`  | 768×1024  |
|             | `3:4`  | 1024×768  |
|             | `16:9` | 1024×576  |
|             | `9:16` | 576×1024  |
|             | `3:2`  | 1024×682  |
|             | `2:3`  | 682×1024  |
|             | `21:9` | 1195×512  |
| `2k` (默认) | `1:1`  | 2048×2048 |
|             | `4:3`  | 2304×1728 |
|             | `3:4`  | 1728×2304 |
|             | `16:9` | 2560×1440 |
|             | `9:16` | 1440×2560 |
|             | `3:2`  | 2496×1664 |
|             | `2:3`  | 1664×2496 |
|             | `21:9` | 3024×1296 |
| `4k`        | `1:1`  | 4096×4096 |
|             | `4:3`  | 4608×3456 |
|             | `3:4`  | 3456×4608 |
|             | `16:9` | 5120×2880 |
|             | `9:16` | 2880×5120 |
|             | `3:2`  | 4992×3328 |
|             | `2:3`  | 3328×4992 |
|             | `21:9` | 6048×2592 |
#### 图生图
**POST** `/v1/images/compositions`
**功能说明**: 基于输入的一张或多张图片，结合文本提示词生成新的图片。支持图片混合、风格转换、内容合成等多种创作模式。

```bash
# 国际版图生图示例 (本地文件上传)
# 美国站使用 "us-YOUR_SESSION_ID"
# 香港站使用 "hk-YOUR_SESSION_ID"
# 日本站使用 "jp-YOUR_SESSION_ID"
curl -X POST http://localhost:5100/v1/images/compositions \
  -H "Authorization: Bearer us-YOUR_SESSION_ID" \
  -F "prompt=A cute cat, anime style" \
  -F "model=jimeng-4.5" \
  -F "images=@/path/to/your/local/cat.jpg"
```
**请求参数**:
- `model` (string, 可选): 使用的模型名称。国内站和国际站（US/HK/JP/SG）均默认 `jimeng-4.5`。
- `prompt` (string): 图像描述文本，用于指导生成方向
- `images` (array): 输入图片数组
- `ratio` (string, 可选): 图像比例，默认为 `"1:1"`。支持的比例: `1:1`, `4:3`, `3:4`, `16:9`, `9:16`, `3:2`, `2:3`, `21:9`。
- `resolution` (string, 可选): 分辨率级别，默认为 `"2k"`。支持的分辨率: `1k`, `2k`, `4k`。
- `intelligent_ratio` (boolean, 可选): 是否启用智能比例，默认为 `false`。**⚠️ 此参数仅对 jimeng-4.0/jimeng-4.1/jimeng-4.5 模型有效，其他模型将忽略此参数。** 启用后系统会根据提示词和输入图片自动调整输出比例。
- `negative_prompt` (string, 可选): 负面提示词
- `sample_strength` (number, 可选): 采样强度 (0.0-1.0)
- `response_format` (string, 可选): 响应格式 ("url"(默认) 或 "b64_json")
**使用限制**:
- 输入图片数量: 1-10张
- 支持的图片格式: JPG, PNG, WebP等常见格式
- 图片大小限制: 建议单张图片不超过100MB
- 生成时间: 通常30秒-5分钟，复杂合成可能需要更长时间
**使用示例**:
```bash
# 示例1: URL图片风格转换 (使用application/json)
curl -X POST http://localhost:5100/v1/images/compositions \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_SESSION_ID" \
  -d '{
    "model": "jimeng-4.5",
    "prompt": "将这张照片转换为油画风格，色彩鲜艳，笔触明显",
    "images": ["https://example.com/photo.jpg"],
    "ratio": "1:1",
    "resolution": "2k",
    "sample_strength": 0.7
  }'
# 示例2: 本地单文件上传 (使用multipart/form-data)
curl -X POST http://localhost:5100/v1/images/compositions \
  -H "Authorization: Bearer YOUR_SESSION_ID" \
  -F "prompt=一只可爱的猫，动漫风格" \
  -F "model=jimeng-4.5" \
  -F "ratio=1:1" \
  -F "resolution=1k" \
  -F "images=@/path/to/your/local/cat.jpg"
# 示例3: 本地多文件上传 (使用multipart/form-data)
curl -X POST http://localhost:5100/v1/images/compositions \
  -H "Authorization: Bearer YOUR_SESSION_ID" \
  -F "prompt=融合这两张图片" \
  -F "model=jimeng-4.5" \
  -F "images=@/path/to/your/image1.jpg" \
  -F "images=@/path/to/your/image2.png"
```
**成功响应示例** (适用于以上所有示例):
```json
{
  "created": 1703123456,
  "data": [
    {
      "url": "https://p3-sign.toutiaoimg.com/tos-cn-i-tb4s082cfz/abc123.webp"
    }
  ],
  "input_images": 1,
  "composition_type": "multi_image_synthesis"
}
```
####  **常见问题与解决方案**
**Q: 图片上传失败怎么办？**
A: 检查图片URL是否可访问，确保图片格式正确，文件大小不超过100MB。
**Q: 生成时间过长怎么办？**
A: 复杂的多图合成需要更长时间，建议耐心等待。如果超过10分钟仍未完成，可以重新提交请求。
**Q: 如何提高合成质量？**
A:
- 使用高质量的输入图片
- 编写详细准确的提示词
- 适当调整 `sample_strength` 参数
- 避免使用过多冲突的图片风格
**Q: 支持哪些图片格式？**
A: 支持 JPG、PNG、WebP、GIF 等常见格式，推荐使用 JPG 或 PNG。
**Q: 可以使用本地图片吗？**
A: 可以。现在支持直接上传本地文件。请参考上方的“本地文件上传示例”。您也可以继续使用原有的网络图片URL方式。
#### 视频生成
**POST** `/v1/videos/generations`
**功能说明**: 基于文本提示词（Text-to-Video），或结合输入的首/尾帧图片（Image-to-Video）生成一段视频。支持三种生成模式：
1.  **文生视频（Text-to-Video）**：纯文本提示词，不使用任何图片
2.  **图生视频（Image-to-Video）**：使用单张图片作为首帧
3.  **首尾帧视频（First-Last Frame）**：使用两张图片分别作为首帧和尾帧
> **模式检测**：系统根据图片的存在情况自动判断生成模式：
>
> - **无图片** → 文生视频模式
> - **1张图片** → 图生视频模式（仅提供 `first_frame_image`）
> - **2张图片** → 首尾帧视频模式（`first_frame_image` 和 `end_frame_image` 均提供）
**请求参数**:
- `model` (string): 使用的视频模型名称。
- `prompt` (string): 视频内容的文本描述。
- `ratio` (string, 可选): 视频比例，默认为 `"1:1"`。支持的比例：`1:1`, `4:3`, `3:4`, `16:9`, `9:16`, `21:9`。**注意**：在图生视频模式下（有图片输入时），此参数将被忽略，视频比例由输入图片的实际比例决定。
- `resolution` (string, 可选): 视频分辨率，默认为 `"720p"`。支持的分辨率：`720p`, `1080p`。
- `duration` (number, 可选): 视频时长（秒），默认为 `5`。支持的值：`5`（5秒），`10`（10秒）。
- `file_paths` (array, 可选): 一个包含图片URL的数组，用于指定视频的**首帧**（数组第1个元素）和**尾帧**（数组第2个元素）。
- `[file]` (file, 可选): 通过 `multipart/form-data` 方式上传的本地图片文件（最多2个），用于指定视频的**首帧**和**尾帧**。字段名可以任意，例如 `image1`。
- `response_format` (string, 可选): 响应格式，支持 `url` (默认) 或 `b64_json`。
> **图片输入说明**:
>
> - 您可以通过 `file_paths` (URL数组) 或直接上传文件两种方式提供输入图片。
> - 如果两种方式同时提供，系统将**优先使用本地上传的文件**。
> - 最多支持2张图片，第1张作为视频首帧，第2张作为视频尾帧。
> - **重要**：一旦提供图片输入（图生视频或首尾帧视频），`ratio` 参数将被忽略，视频比例将由输入图片的实际比例决定。`resolution` 参数仍然有效。
**支持的视频模型**:
- `jimeng-video-3.0-pro` - 专业版
- `jimeng-video-3.0` - 标准版
- `jimeng-video-3.0-fast` - 极速版（仅国内站支持）
- `jimeng-video-2.0-pro` - 专业版v2
- `jimeng-video-2.0` - 标准版v2
**使用示例**:
```bash
# 示例1: 文生视频（0张图片） - 纯文本生成
curl -X POST http://localhost:5100/v1/videos/generations \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_SESSION_ID" \
  -d '{
    "model": "jimeng-video-3.0",
    "prompt": "一只奔跑在草原上的狮子",
    "ratio": "16:9",
    "resolution": "1080p",
    "duration": 10
  }'
# 示例2: 图生视频（1张图片） - 单张图片作为首帧
curl -X POST http://localhost:5100/v1/videos/generations \
  -H "Authorization: Bearer YOUR_SESSION_ID" \
  -F "prompt=一个男人在说话" \
  -F "model=jimeng-video-3.0" \
  -F "ratio=9:16" \
  -F "duration=5" \
  -F "image_file_1=@/path/to/your/first-frame.png"
# 示例3: 首尾帧视频（2张图片） - 两张图片分别作为首帧和尾帧
curl -X POST http://localhost:5100/v1/videos/generations \
  -H "Authorization: Bearer YOUR_SESSION_ID" \
  -F "prompt=场景之间的平滑过渡" \
  -F "model=jimeng-video-3.0" \
  -F "ratio=16:9" \
  -F "duration=10" \
  -F "image_file_1=@/path/to/first-frame.png" \
  -F "image_file_2=@/path/to/last-frame.png"
# 示例4: 使用网络图片的图生视频
curl -X POST http://localhost:5100/v1/videos/generations \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_SESSION_ID" \
  -d '{
    "model": "jimeng-video-3.0",
    "prompt": "一个女人在花园里跳舞",
    "ratio": "4:3",
    "duration": 10,
    "filePaths": ["https://example.com/your-image.jpg"]
  }'
```

### 5.用户使用场景

1.用户输入100个分镜文案生成视频，生成到一半账号全都是变成不可用的账号，后面的全部失败，提示用户补充账号后，使用批量重试

​	重试只对失败的，不对成功的进行重新生成

2.用户输入全部完成后，感觉某个视频，或者几个视频都不符合满意要求，需要进行批量重试也要支持单个重试

3.10个图片或者视频生成，用户需要实时看到生成进度，生成完成一个就写入一个结果到数据库，进度到达10%，让用户实时看到进度结果



### 6.最新设计需实现API

我就只是需要确保数据能够新增或者修改到表：jimeng_accounts中

#### 创建账号接口

​	类型：POST

​	参数：json对象数组数据

​		[{

​		jimeng_account：可选

​		jimeng_account_type：可选

​		sessionid_id：可选

​		},{

​		jimeng_account：可选

​		jimeng_account_type：可选

​		sessionid_id：可选

​		}]

​		数组不允许为空

​	流程：

​		site_type：根据jimeng_account_type决定，如果是是no_cn就默认填入hk

​		quota_reset_time：额度重置时间，由应用在账号创建时写入为“创建日期+1天的0:30”

​		create_by VARCHAR(50) COMMENT '创建人'  项目是如何获取到当前登录用户ID的，就用这种方式获取到自动填入

​	响应：新增成功

​	说明：

#### 修改账号接口

​	类型：POST

​	参数：json对象数组数据

​		[{

​		id：必填

​		jimeng_account：可选

​		jimeng_account_type：可选

​		sessionid_id：可选

​		},{

​		id：必填

​		jimeng_account：可选

​		jimeng_account_type：可选

​		sessionid_id：可选

​		}]

​		数组不允许为空



​	流程：

​		site_type：根据jimeng_account_type决定，如果是是no_cn就默认填入hk

​		update_by VARCHAR(50) COMMENT '修改人'  项目是如何获取到当前登录用户ID的，就用这种方式获取到自动填入

​	响应：新增成功

​	说明：

#### 分镜文生图

​	类型：POST

​	参数：



​	流程：



​	响应：

​	说明：

#### 分镜图生图

​	类型：POST

​	参数：



​	流程：



​	响应：

​	说明：

#### 分镜生视频



​	类型：POST

​	参数：



​	流程：



​	响应：

​	说明：（文生视频，图生视频返回一致不做区分）