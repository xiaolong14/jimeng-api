## 需求理解

您需要为AI动漫项目设计一套即梦API接口，主要用于：



1. **小说转动漫场景**：将分镜文案通过AI生成动漫画面和视频
2. **详细记录管理**：保存所有生成记录，便于查看和追踪
3. **智能容错机制**：账号异常时自动切换重试，确保生成成功率
4. **数据管理功能**：提供完整的增删改查接口

基于您已有的核心流程接口，我将补充完善的查询、修改、删除接口设计。



## 补充接口文档

### 5. 账号管理接口

#### 5.1 创建账号

- **类型**：POST
- **路径**：`/api/v1/jimeng/accounts/create`
- **参数**：



```json
{
  "accounts": [
    {
      "jimeng_account": "即梦账号",
      "jimeng_account_type": 0,  // 0-国内账号，1-国外账号
      "session_id": "登录状态ID"
    }
  ]
}
```

- 流程

  ：

  1. 验证数组不为空
  2. 根据jimeng_account_type设置site_type（国外账号默认为hk）
  3. 生成雪花UUID作为id
  4. 设置quota_reset_time为创建日期+1天的0:30
  5. 自动获取当前登录用户ID填入create_by

- **响应**：



```json
{
  "code": 200,
  "message": "账号创建成功",
  "data": {
    "success_count": 1,
    "failed_count": 0
  }
}
```

#### 5.2 修改账号

- **类型**：POST
- **路径**：`/api/v1/jimeng/accounts/update`
- **参数**：



```json
{
  "accounts": [
    {
      "id": "雪花UUID",  // 必填
      "jimeng_account": "即梦账号",
      "jimeng_account_type": 0,
      "session_id": "登录状态ID"
    }
  ]
}
```

- 流程

  ：

  1. 验证id必填
  2. 根据jimeng_account_type更新site_type
  3. 自动获取当前登录用户ID填入update_by

- **响应**：



```json
{
  "code": 200,
  "message": "账号修改成功",
  "data": {
    "success_count": 1,
    "failed_count": 0
  }
}
```

#### 5.3 查询账号列表（分页）

- **类型**：GET

- **路径**：`/api/v1/jimeng/accounts/list`

- 参数

  ：

  - `page`：页码（默认1）
  - `size`：每页数量（默认20）
  - `account_status`：账号状态（可选筛选）
  - `site_type`：站点类型（可选筛选）

- 流程

  ：

  1. 根据当前登录用户查询账号
  2. 支持按状态和站点类型筛选
  3. 按priority和create_time排序

- **响应**：



```json
{
  "code": 200,
  "message": "查询成功",
  "data": {
    "total": 100,
    "page": 1,
    "size": 20,
    "list": [
      {
        "id": "雪花UUID",
        "jimeng_account": "账号名",
        "jimeng_account_type": 0,
        "session_id": "sessionID",
        "site_type": 0,
        "account_status": 0,
        "image_generation_status": 1,
        "video_generation_status": 1,
        "image_count": 5,
        "video_count": 2,
        "quota_reset_time": "2025-01-01 00:30:00",
        "create_time": "2024-12-18 10:00:00",
        "update_time": "2024-12-18 10:00:00"
      }
    ]
  }
}
```

#### 5.4 删除账号（逻辑删除）

- **类型**：POST
- **路径**：`/api/v1/jimeng/accounts/delete`
- **参数**：



```json
{
  "ids": ["雪花UUID1", "雪花UUID2"]
}
```

- 流程

  ：

  1. 验证权限（只能删除自己创建的账号）
  2. 执行逻辑删除，更新is_deleted=1
  3. 自动填入update_by

- **响应**：



```json
{
  "code": 200,
  "message": "账号删除成功",
  "data": {
    "success_count": 2
  }
}
```

#### 5.5 重置账号状态

- **类型**：POST
- **路径**：`/api/v1/jimeng/accounts/reset-status`
- **参数**：



```json
{
  "id": "雪花UUID"
}
```

- 流程

  ：

  1. 重置image_generation_status和video_generation_status为1
  2. 清空image_count和video_count
  3. 更新quota_reset_time为次日0:30

- **响应**：



```json
{
  "code": 200,
  "message": "账号状态重置成功"
}
```

### 6. 生成记录接口

#### 6.1 查询生成记录（分页）

- **类型**：GET

- **路径**：`/api/v1/jimeng/records/list`

- 参数

  ：

  - `type`：记录类型（image/video）
  - `work_id`：作品ID（必填）
  - `page`：页码（默认1）
  - `size`：每页数量（默认20）
  - `generation_status`：生成状态（可选筛选）
  - `start_time`：开始时间（可选筛选）
  - `end_time`：结束时间（可选筛选）

- 流程

  ：

  1. 根据work_id和当前用户查询记录
  2. 根据type选择查询图片或视频记录表
  3. 支持按状态和时间范围筛选

- **响应**：



```json
{
  "code": 200,
  "message": "查询成功",
  "data": {
    "total": 50,
    "page": 1,
    "size": 20,
    "list": [
      {
        "id": "雪花UUID",
        "project_id": "项目ID",
        "project_name": "项目名称",
        "storyboard_id": "分镜ID",
        "work_id": "作品ID",
        "model": "jimeng-4.5",
        "prompt": "生成提示词",
        "ratio": "16:9",
        "resolution": "2k",
        "generation_status": 2,
        "site_used": 0,
        "image_urls": ["https://xxx.png"],
        "generation_time": 30,
        "site_switch_count": 1,
        "create_time": "2024-12-18 10:00:00",
        "update_time": "2024-12-18 10:00:30"
      }
    ]
  }
}
```

#### 6.2 重新生成（基于分镜ID）

- **类型**：POST
- **路径**：`/api/v1/jimeng/{type}/regenerate`
- **参数**：



```json
{
  "storyboard_id": "分镜ID",
  "project_id": "项目ID",
  "project_name": "项目名称",
  "work_id": "作品ID",
  "prompt": "新的提示词",  // 可选，不填则使用原提示词
  "model": "jimeng-4.5",  // 可选，不填则使用原模型
  "ratio": "16:9",  // 图片特有，可选
  "resolution": "2k",  // 图片特有，可选
  "duration": 5,  // 视频特有，可选
  "input_images": ["https://xxx.png"]  // 可选，图生图/图生视频时使用
}
```

- 流程

  ：

  1. 根据storyboard_id查找现有记录
  2. 保留原有id，更新其他字段
  3. 重新执行生成流程
  4. 覆盖原有记录的图片/视频URL
  5. 更新生成状态和时间

- **响应**：



```json
{
  "code": 200,
  "message": "重新生成任务已提交",
  "data": {
    "record_id": "雪花UUID",
    "task_id": "任务ID"
  }
}
```

#### 6.3 删除生成记录

- **类型**：POST
- **路径**：`/api/v1/jimeng/records/delete`
- **参数**：



```json
{
  "type": "image",  // image/video
  "ids": ["雪花UUID1", "雪花UUID2"]
}
```

- 流程

  ：

  1. 验证权限（只能删除自己项目的记录）
  2. 执行逻辑删除，更新is_deleted=1
  3. 删除关联的本地文件（可选）

- **响应**：



```json
{
  "code": 200,
  "message": "记录删除成功",
  "data": {
    "success_count": 2
  }
}
```

#### 6.4 获取生成详情

- **类型**：GET

- **路径**：`/api/v1/jimeng/records/detail`

- 参数

  ：

  - `type`：记录类型（image/video）
  - `id`：记录ID

- 流程

  ：

  1. 查询详细记录信息
  2. 返回完整的生成参数和结果

- **响应**：



```json
{
  "code": 200,
  "message": "查询成功",
  "data": {
    "id": "雪花UUID",
    "project_id": "项目ID",
    "project_name": "项目名称",
    "storyboard_id": "分镜ID",
    "work_id": "作品ID",
    "model": "jimeng-4.5",
    "prompt": "生成提示词",
    "negative_prompt": "负面提示词",
    "ratio": "16:9",
    "resolution": "2k",
    "input_images": ["https://xxx.png"],
    "original_session_id": "原sessionID",
    "site_used": 0,
    "generation_status": 2,
    "image_urls": ["https://xxx.png"],
    "image_local_paths": ["/local/path/xxx.png"],
    "generation_time": 30,
    "error_message": null,
    "site_switch_count": 1,
    "callback_url": "回调地址",
    "create_time": "2024-12-18 10:00:00",
    "update_time": "2024-12-18 10:00:30"
  }
}
```

#### 6.5 批量查询分镜记录

- **类型**：POST
- **路径**：`/api/v1/jimeng/records/batch`
- **参数**：



```json
{
  "type": "image",  // image/video
  "work_id": "作品ID",
  "storyboard_ids": ["分镜ID1", "分镜ID2"]
}
```

- 流程

  ：

  1. 批量查询多个分镜的生成记录
  2. 返回每个分镜的最新生成结果

- **响应**：



```json
{
  "code": 200,
  "message": "查询成功",
  "data": {
    "records": [
      {
        "storyboard_id": "分镜ID1",
        "record": {
          "id": "雪花UUID",
          "generation_status": 2,
          "image_urls": ["https://xxx.png"],
          "create_time": "2024-12-18 10:00:00"
        }
      },
      {
        "storyboard_id": "分镜ID2",
        "record": null
      }
    ]
  }
}
```

### 7. 统计接口

#### 7.1 获取账号使用统计

- **类型**：GET

- **路径**：`/api/v1/jimeng/accounts/statistics`

- **参数**：无

- 流程

  ：

  1. 统计当前用户各状态账号数量
  2. 统计今日可用/不可用账号数
  3. 返回账号使用情况概览

- **响应**：



```json
{
  "code": 200,
  "message": "查询成功",
  "data": {
    "total_accounts": 10,
    "active_accounts": 8,
    "inactive_accounts": 1,
    "banned_accounts": 1,
    "image_available_accounts": 7,
    "video_available_accounts": 6,
    "rate_limited_accounts": 2
  }
}
```

#### 7.2 获取生成任务统计

- **类型**：GET

- **路径**：`/api/v1/jimeng/records/statistics`

- 参数

  ：

  - `work_id`：作品ID（可选）
  - `date_range`：日期范围（today/week/month，可选）

- 流程

  ：

  1. 统计生成任务数量和状态分布
  2. 计算成功率和平均耗时
  3. 按日期或作品分组统计

- **响应**：



```json
{
  "code": 200,
  "message": "查询成功",
  "data": {
    "total_tasks": 100,
    "completed_tasks": 80,
    "failed_tasks": 15,
    "pending_tasks": 5,
    "success_rate": 0.8,
    "avg_generation_time": 45,
    "daily_stats": [
      {
        "date": "2024-12-18",
        "image_count": 20,
        "video_count": 10,
        "success_rate": 0.85
      }
    ]
  }
}
```

### 9. 批量生成接口

#### 9.1 批量文生图

- **类型**：POST
- **路径**：`/api/v1/jimeng/images/batch-generate`
- **参数**：
```json
{
  "project_id": "项目ID",
  "project_name": "项目名称",
  "work_id": "作品ID",
  "batch_data": [
    {
      "storyboard_id": "分镜ID1",
      "prompt": "画面描述1",
      "negative_prompt": "负面描述1",  // 可选
      "ratio": "16:9",  // 可选，默认1:1
      "resolution": "2k",  // 可选，默认2k
      "intelligent_ratio": false,  // 可选
      "sample_strength": 0.8,  // 可选
      "model": "jimeng-4.5"  // 可选，默认项目配置
    },
    {
      "storyboard_id": "分镜ID2",
      "prompt": "画面描述2",
      "ratio": "4:3",
      "resolution": "1080p"
    }
  ],
  "global_config": {  // 全局配置，可选
    "model": "jimeng-4.5",
    "resolution": "2k",
    "callback_url": "回调地址",
    "priority": 1
  }
}
```
- **流程**：
  1. 验证batch_data数组不为空（最多1000个）
  2. 检查每个分镜是否已存在生成记录，存在则跳过或覆盖（根据配置，默认直接覆盖）
  3. 创建批量任务记录，返回batch_id
  4. 将任务加入队列，并发执行（考虑账号负载均衡）
  5. 支持断点续传，失败的可以单独重试
- **响应**：
```json
{
  "code": 200,
  "message": "批量文生图任务已提交",
  "data": {
    "batch_id": "批次ID",
    "total_count": 50,
    "skip_count": 5,  // 跳过已存在的数量
    "queue_count": 45,
    "estimated_time": 1800,  // 预估完成时间（秒）
    "task_id": "异步任务ID"
  }
}
```

#### 9.2 批量图生图

- **类型**：POST
- **路径**：`/api/v1/jimeng/images/batch-compose`
- **参数**：
```json
{
  "project_id": "项目ID",
  "project_name": "项目名称",
  "work_id": "作品ID",
  "batch_data": [
    {
      "storyboard_id": "分镜ID1",
      "prompt": "画面描述1",
      "input_images": ["https://example.com/image1.jpg"],  // 图片URL数组
      "ratio": "16:9",  // 可选
      "resolution": "2k",  // 可选
      "sample_strength": 0.7  // 可选
    }
  ],
  "global_config": {  // 全局配置，可选
    "model": "jimeng-4.5",
    "callback_url": "回调地址"
  }
}
```
- **说明**：
  - 每个分镜最多10张输入图片
  - 自动处理图片上传和压缩
- **响应**：
```json
{
  "code": 200,
  "message": "批量图生图任务已提交",
  "data": {
    "batch_id": "批次ID",
    "total_count": 30,
    "queue_count": 30,
    "estimated_time": 2400,
    "task_id": "异步任务ID"
  }
}
```

#### 9.3 批量文生视频

- **类型**：POST
- **路径**：`/api/v1/jimeng/videos/batch-generate`
- **参数**：
```json
{
  "project_id": "项目ID",
  "project_name": "项目名称",
  "work_id": "作品ID",
  "batch_data": [
    {
      "storyboard_id": "分镜ID1",
      "prompt": "视频描述1",
      "ratio": "16:9",  // 可选，默认16:9
      "resolution": "720p",  // 可选，默认720p
      "duration": 5,  // 可选，5或10秒
      "model": "jimeng-video-3.0"  // 可选
    },
    {
      "storyboard_id": "分镜ID2",
      "prompt": "视频描述2",
      "duration": 10
    }
  ],
  "global_config": {
    "model": "jimeng-video-3.0",
    "callback_url": "回调地址",
    "priority": 1
  }
}
```
- **流程**：
  1. 验证批量数据完整性
  2. 考虑视频生成资源消耗，限制并发数量（如最多同时5个）
  3. 智能分配账号，避免单账号过载
  4. 支持优先级队列
- **响应**：
```json
{
  "code": 200,
  "message": "批量文生视频任务已提交",
  "data": {
    "batch_id": "批次ID",
    "total_count": 20,
    "queue_count": 20,
    "estimated_time": 3600,  // 视频生成时间较长
    "task_id": "异步任务ID"
  }
}
```

#### 9.4 批量图生视频

- **类型**：POST
- **路径**：`/api/v1/jimeng/videos/batch-compose`
- **参数**：
```json
{
  "project_id": "项目ID",
  "project_name": "项目名称",
  "work_id": "作品ID",
  "batch_data": [
    {
      "storyboard_id": "分镜ID1",
      "prompt": "视频描述1",
      "input_images": ["https://xxx.jpg"],  // 首帧图片
      "duration": 5,
      "ratio": "16:9"  // 有图片时此参数会被忽略
    },
    {
      "storyboard_id": "分镜ID2",
      "prompt": "转场描述",
      "input_images": ["https://start.jpg", "https://end.jpg"],  // 首尾帧
      "duration": 10
    }
  ],
  "global_config": {
    "model": "jimeng-video-3.0",
    "callback_url": "回调地址"
  }
}
```

### 10. 批量任务管理接口

#### 10.1 查询批量任务状态

- **类型**：GET
- **路径**：`/api/v1/jimeng/batch/{batch_id}/status`
- **参数**：
  - `batch_id`：批次ID
- **响应**：
```json
{
  "code": 200,
  "message": "查询成功",
  "data": {
    "batch_id": "批次ID",
    "batch_type": "image_generate",  // image_generate/video_generate
    "total_count": 50,
    "completed_count": 30,
    "failed_count": 5,
    "processing_count": 10,
    "pending_count": 5,
    "progress": 0.6,  // 完成进度
    "start_time": "2024-12-18 10:00:00",
    "estimated_completion": "2024-12-18 11:30:00",
    "status": "processing",  // pending/processing/completed/partial_failed/failed
    "details": [
      {
        "storyboard_id": "分镜ID1",
        "status": "completed",
        "result_urls": ["https://xxx.png"],
        "generation_time": 30
      },
      {
        "storyboard_id": "分镜ID2",
        "status": "failed",
        "error_message": "账号额度不足",
        "retry_count": 2
      }
    ]
  }
}
```

#### 10.2 批量任务重试

- **类型**：POST
- **路径**：`/api/v1/jimeng/batch/{batch_id}/retry`
- **参数**：
```json
{
  "storyboard_ids": ["分镜ID1", "分镜ID2"],  // 可选，不填则重试所有失败的
  "force_regenerate": false  // 是否强制重新生成（覆盖已有成功记录）
}
```
- **流程**：
  1. 筛选需要重试的分镜
  2. 重新加入生成队列
  3. 保留原有重试次数
- **响应**：
```json
{
  "code": 200,
  "message": "重试任务已提交",
  "data": {
    "retry_count": 5,
    "batch_id": "批次ID",
    "task_id": "新任务ID"
  }
}
```

#### 10.3 批量任务取消

- **类型**：POST
- **路径**：`/api/v1/jimeng/batch/{batch_id}/cancel`
- **参数**：
```json
{
  "reason": "取消原因"
}
```
- **流程**：
  1. 取消队列中待处理的任务
  2. 标记批次为已取消
  3. 释放占用的账号资源
  4. 已完成的任务不受影响
- **响应**：
```json
{
  "code": 200,
  "message": "批量任务已取消",
  "data": {
    "cancelled_count": 10,
    "completed_count": 20,
    "affected_storyboards": ["分镜ID1", "分镜ID2"]
  }
}
```

### 11. 批量操作优化特性

#### 11.1 智能账号分配策略
```json
{
  "account_strategy": {
    "load_balance": "round_robin",  // round_robin/least_used/priority
    "max_concurrent_per_account": 3,  // 单账号最大并发
    "auto_switch_on_failure": true,  // 失败自动切换
    "rate_limit_handling": "wait"  // wait/skip/switch_on_limit
  }
}
```

#### 11.2 批量任务优先级
```json
{
  "priority_levels": {
    "urgent": 1,    // 紧急：实时生成，独占资源
    "high": 2,      // 高优先级：优先处理
    "normal": 3,    // 普通：FIFO队列
    "low": 4        // 低优先级：资源空闲时处理
  }
}
```

#### 11.3 断点续传支持
- 记录每个分镜的生成状态
- 支持从失败点继续执行
- 保留成功的记录，只重试失败项
- 提供增量更新机制

#### 11.4 性能优化建议
1. **分批处理**：大批量任务自动拆分为小批次（如每批20个）
2. **并发控制**：根据账号数量动态调整并发数
3. **资源监控**：实时监控CPU、内存、网络使用情况
4. **缓存复用**：相似提示词可复用生成结果
5. **预热机制**：提前准备可用账号池

### 12. 回调通知机制

#### 批量任务完成回调
```json
{
  "event": "batch_completed",
  "batch_id": "批次ID",
  "project_id": "项目ID",
  "work_id": "作品ID",
  "summary": {
    "total": 50,
    "success": 45,
    "failed": 5,
    "success_rate": 0.9
  },
  "results": [
    {
      "storyboard_id": "分镜ID",
      "status": "success/failed",
      "urls": ["https://xxx.png"],
      "error": null
    }
  ],
  "timestamp": "2024-12-18 10:30:00"
}
```

### 13. 注意事项说明

1. **权限控制**：所有接口都需要验证当前登录用户，确保只能操作自己的数据
2. **错误处理**：统一错误码和错误信息格式
3. **日志记录**：记录关键操作日志，便于追踪和调试
4. **参数验证**：对必填参数进行严格验证
5. **文件管理**：生成的图片/视频需要定期清理，避免占用过多存储空间
6. **并发控制**：避免同一分镜重复生成，使用分布式锁控制
7. **缓存机制**：对查询结果进行缓存，提高响应速度
8. **批量限制**：单次批量任务最多支持100个分镜，视频生成建议不超过50个
9. **资源隔离**：不同批量任务使用不同的资源队列，避免互相影响
10. **监控告警**：对批量任务的执行状态进行监控，异常时及时告警

这份完整的接口文档包含了账号管理、生成记录管理、批量生成、任务管理和统计功能，充分满足AI动漫项目的需求。

