
## 数据库表设计方案

### 表1：即梦账号管理表（jimeng_accounts）

**用途**：管理即梦AI账号池，支持多站点和生成次数统计

```sql
CREATE TABLE jimeng_accounts (
    id VARCHAR(36) PRIMARY KEY COMMENT '雪花UUID',
    jimeng_account VARCHAR(100) NOT NULL COMMENT '即梦账号',
    jimeng_account_type TINYINT(1) DEFAULT 0 COMMENT '即梦账号类型：0-国内账号，1-国外账号',
    session_id VARCHAR(200) NOT NULL COMMENT '登录状态ID',
    site_type TINYINT(1) DEFAULT 0 COMMENT '站点类型：0-cn，1-us，2-hk，3-jp，4-sg',
    account_status TINYINT(1) DEFAULT 0 COMMENT '账号状态：0-active(正常)，1-inactive(停用)，2-banned(封禁)',
    image_generation_status TINYINT(1) DEFAULT 1 COMMENT '生图状态：0-不可用，1-可用，2-速率限制',
    video_generation_status TINYINT(1) DEFAULT 1 COMMENT '生视频状态：0-不可用，1-可用，2-速率限制',
    image_count INT DEFAULT 0 COMMENT '图片生成次数',
    video_count INT DEFAULT 0 COMMENT '视频生成次数',
    image_unavailable_time TIMESTAMP NULL COMMENT '生图失效时间，当生图状态变为0，2不可用时记录，用于额度刷新时恢复状态',
    video_unavailable_time TIMESTAMP NULL COMMENT '生视频失效时间，当生视频状态变为0，2不可用时记录，用于额度刷新时恢复状态',
    quota_reset_time TIMESTAMP NULL COMMENT '额度重置时间，由应用在账号创建时写入为“创建日期+1天的0:30”，后续在额度隔天刷新为可用状态时一并更新',
    priority INT DEFAULT 0 COMMENT '账号优先级',
    max_retry_count INT DEFAULT 4 COMMENT '最大重试次数，代码中默认的采用指数退避3-5-10-15，请你写的更多点，方便我以后增加重试次数，能够知道后续等待时间',
    version INT DEFAULT 1 COMMENT '版本号',
    is_deleted TINYINT(1) DEFAULT 0 COMMENT '逻辑删除标记',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    create_by VARCHAR(50) COMMENT '创建人',
    update_by VARCHAR(50) COMMENT '修改人',
    attr1 VARCHAR(255) COMMENT '扩展字段1',
    attr2 VARCHAR(255) COMMENT '扩展字段2',
    attr3 TEXT COMMENT '扩展字段3',

    UNIQUE KEY uk_session_site (session_id, site_type),
    INDEX idx_account_status (account_status),
    INDEX idx_generation_status (image_generation_status, video_generation_status),
    INDEX idx_priority_create_time (priority DESC, create_time DESC)
) COMMENT='即梦账号管理表';
```

**字段说明**：
- `jimeng_account_type`: 即梦账号类型，数字编码；0-国内账号，1-国外账号
- `site_type`: 站点类型，数字编码；0-cn，1-us，2-hk，3-jp，4-sg
- `account_status`: 账号状态，数字编码；0-active(正常)，1-inactive(停用)，2-banned(封禁)
- `image_generation_status`: 生图状态，数字编码；0-不可用，1-可用，2-速率限制
- `video_generation_status`: 生视频状态，数字编码；0-不可用，1-可用，2-速率限制
- `image_count`: 当日图片生成次数
- `video_count`: 当日视频生成次数
- `image_unavailable_time`: 生图失效时间，当生图状态变为不可用（0-不可用或2-速率限制）时记录，程序在额度刷新时根据此时间与`quota_reset_time`对比来恢复生图可用状态
- `video_unavailable_time`: 生视频失效时间，当生视频状态变为不可用（0-不可用或2-速率限制）时记录，程序在额度刷新时根据此时间与`quota_reset_time`对比来恢复生视频可用状态

### 表2：图片生成任务记录表（jimeng_image_generation_records）

**用途**：记录图片生成任务，与cartoon项目的作品和分镜建立关联

```sql
CREATE TABLE jimeng_image_generation_records (
    id VARCHAR(36) PRIMARY KEY COMMENT '雪花UUID',
    jimeng_accounts_id VARCHAR(36) NOT NULL COMMENT '即梦账号表ID 逻辑外键不建立外键索引',
    project_id VARCHAR(50) NOT NULL COMMENT '推理项目ID',
    project_name VARCHAR(50) NOT NULL COMMENT '推理项目名称',   
    storyboard_id VARCHAR(50) NOT NULL COMMENT '分镜ID',
    work_id VARCHAR(50) NOT NULL COMMENT '作品id',
    model VARCHAR(50) NOT NULL COMMENT '使用的模型',
    prompt TEXT NOT NULL COMMENT '生成提示词',
    negative_prompt TEXT COMMENT '负面提示词',
    ratio VARCHAR(10) DEFAULT '1:1' COMMENT '宽高比，支持：1:1, 4:3, 3:4, 16:9, 9:16, 3:2, 2:3, 21:9',
    resolution VARCHAR(10) DEFAULT '2k' COMMENT '分辨率，支持：1k, 2k, 4k',
    intelligent_ratio TINYINT(1) DEFAULT 0 COMMENT '是否启用智能比例，0-否，1-是，仅对jimeng-4.0/jimeng-4.1/jimeng-4.5模型有效',
    sample_strength DECIMAL(3,2) COMMENT '采样强度，范围0.0-1.0',
    response_format VARCHAR(20) DEFAULT 'url' COMMENT '响应格式，url或b64_json',
    input_images JSON COMMENT '输入图片URLs数组（图生图时使用）',
    original_session_id VARCHAR(200) COMMENT '原始session_id',
    site_used TINYINT(1) COMMENT '实际使用的站点：0-cn，1-us，2-hk，3-jp，4-sg',
    generation_status TINYINT(1) DEFAULT 0 COMMENT '生成状态：0-pending，1-processing，2-completed，3-failed，4-retrying',
    image_urls JSON COMMENT '生成图片URL数组',
    image_local_paths JSON COMMENT '图片本地路径数组',
    generation_time INT COMMENT '生成耗时(秒)',
    error_code VARCHAR(20) COMMENT '错误码',
    error_message TEXT COMMENT '错误信息',
    site_switch_count INT DEFAULT 0 COMMENT '站点切换次数',
    priority INT DEFAULT 0 COMMENT '任务优先级',
    callback_url VARCHAR(500) COMMENT '回调地址',
    version INT DEFAULT 1 COMMENT '版本号',
    is_deleted TINYINT(1) DEFAULT 0 COMMENT '逻辑删除标记',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    create_by VARCHAR(50) COMMENT '创建人',
    update_by VARCHAR(50) COMMENT '修改人',
    attr1 VARCHAR(255) COMMENT '扩展字段1',
    attr2 VARCHAR(255) COMMENT '扩展字段2',
    attr3 TEXT COMMENT '扩展字段3',

    INDEX idx_jimeng_accounts_id_status (jimeng_accounts_id, generation_status),
    UNIQUE KEY uk_project_storyboard (project_id, storyboard_id, is_deleted),
    INDEX idx_project_storyboard (project_id, storyboard_id),
    INDEX idx_status_create_time (generation_status, create_time)
) COMMENT='图片生成任务记录表';
```

**字段说明**：
- `project_id`: 推理项目ID
- `project_name`: 推理项目名称
- `work_id`: 作品ID
- `storyboard_id`: 分镜ID
- `site_used`: 实际使用的站点，数字编码；0-cn，1-us，2-hk，3-jp，4-sg
- `generation_status`: 生成状态，数字编码；0-pending，1-processing，2-completed，3-failed，4-retrying
- `image_urls`: 生成图片URL数组
- `image_local_paths`: 图片本地路径数组
- `site_switch_count`: 站点切换次数
- `intelligent_ratio`: 智能比例功能，启用后系统会根据提示词自动推断最佳图像比例
- `sample_strength`: 采样强度，用于控制生成图片与输入图片的相似度（图生图时使用）

### 表3：视频生成任务记录表（jimeng_video_generation_records）

**用途**：记录视频生成任务，与cartoon项目的作品和分镜建立关联

```sql
CREATE TABLE jimeng_video_generation_records (
    id VARCHAR(36) PRIMARY KEY COMMENT '雪花UUID',
    jimeng_accounts_id VARCHAR(36) NOT NULL COMMENT '即梦账号表ID 逻辑外键不建立外键索引',
    project_id VARCHAR(50) NOT NULL COMMENT '推理项目ID',
    project_name VARCHAR(50) NOT NULL COMMENT '推理项目名称',   
    storyboard_id VARCHAR(50) NOT NULL COMMENT '分镜ID',
    work_id VARCHAR(50) NOT NULL COMMENT '作品id',
    model VARCHAR(50) NOT NULL COMMENT '使用的模型',
    prompt TEXT NOT NULL COMMENT '生成提示词',
    negative_prompt TEXT COMMENT '负面提示词',
    ratio VARCHAR(10) DEFAULT '16:9' COMMENT '宽高比，支持：1:1, 4:3, 3:4, 16:9, 9:16, 21:9（图生视频时此参数会被忽略）',
    resolution VARCHAR(10) DEFAULT '720p' COMMENT '视频分辨率，支持：720p, 1080p',
    duration INT DEFAULT 5 COMMENT '视频时长(秒)，支持：5, 10',
    response_format VARCHAR(20) DEFAULT 'url' COMMENT '响应格式，url或b64_json',
    input_images JSON COMMENT '输入图片URLs数组(图生视频或首尾帧视频)',
    original_session_id VARCHAR(200) COMMENT '原始session_id',
    site_used TINYINT(1) COMMENT '实际使用的站点：0-cn，1-us，2-hk，3-jp，4-sg',
    generation_status TINYINT(1) DEFAULT 0 COMMENT '生成状态：0-pending，1-processing，2-completed，3-failed，4-retrying',
    remote_task_id VARCHAR(100) COMMENT '远程任务ID',
    video_urls JSON COMMENT '生成视频URL数组',
    video_local_paths JSON COMMENT '视频本地路径数组',
    generation_time INT COMMENT '生成耗时(秒)',
    error_code VARCHAR(20) COMMENT '错误码',
    error_message TEXT COMMENT '错误信息',
    site_switch_count INT DEFAULT 0 COMMENT '站点切换次数',
    priority INT DEFAULT 0 COMMENT '任务优先级',
    callback_url VARCHAR(500) COMMENT '回调地址',
    version INT DEFAULT 1 COMMENT '版本号',
    is_deleted TINYINT(1) DEFAULT 0 COMMENT '逻辑删除标记',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    create_by VARCHAR(50) COMMENT '创建人',
    update_by VARCHAR(50) COMMENT '修改人',
    attr1 VARCHAR(255) COMMENT '扩展字段1',
    attr2 VARCHAR(255) COMMENT '扩展字段2',
    attr3 TEXT COMMENT '扩展字段3',

    INDEX idx_jimeng_accounts_id_status (jimeng_accounts_id, generation_status),
    UNIQUE KEY uk_project_storyboard (project_id, storyboard_id, is_deleted),
    INDEX idx_project_storyboard (project_id, storyboard_id),
    INDEX idx_status_create_time (generation_status, create_time),
    INDEX idx_remote_task_id (remote_task_id)
) COMMENT='视频生成任务记录表';
```

**字段说明**：
- `project_id`: 推理项目ID
- `project_name`: 推理项目名称
- `work_id`: 作品ID
- `storyboard_id`: 分镜ID
- `site_used`: 实际使用的站点，数字编码；0-cn，1-us，2-hk，3-jp，4-sg
- `generation_status`: 生成状态，数字编码；0-pending，1-processing，2-completed，3-failed，4-retrying
- `video_urls`: 生成视频URL数组
- `video_local_paths`: 视频本地路径数组
- `site_switch_count`: 站点切换次数
- `duration`: 视频时长，支持5秒或10秒
- `input_images`: 输入图片数组，用于图生视频或首尾帧视频模式



### 2. 关键索引设计

- 图片记录复合索引：(project_id, storyboard_id, is_deleted)
- 视频记录复合索引：(project_id, storyboard_id, is_deleted)
- 状态索引：(jimeng_accounts_id, generation_status)
- 时间索引：(generation_status, create_time)

### 3. 数据同步机制

- 图片记录表 ↔ inference_project表双向同步
- 视频记录表 ↔ inference_project表双向同步
- 通过JSON字段存储session_id数组，支持多账号关联
- 使用is_deleted字段实现软删除，保留历史记录

---

## 数据库表结构表格

### 表1：jimeng_accounts（即梦账号管理表）

| 字段名 | 数据类型 | 是否为空 | 默认值 | 说明 |
|--------|---------|---------|--------|------|
| id | VARCHAR(36) | NOT NULL | - | 主键，雪花UUID |
| jimeng_account | VARCHAR(100) | NOT NULL | - | 即梦账号 |
| jimeng_account_type | TINYINT(1) | NULL | 0 | 即梦账号类型：0-国内账号，1-国外账号 |
| session_id | VARCHAR(200) | NOT NULL | - | 登录状态ID |
| site_type | TINYINT(1) | NULL | 0 | 站点类型：0-cn，1-us，2-hk，3-jp，4-sg |
| account_status | TINYINT(1) | NULL | 0 | 账号状态：0-active(正常)，1-inactive(停用)，2-banned(封禁) |
| image_generation_status | TINYINT(1) | NULL | 1 | 生图状态：0-不可用，1-可用，2-速率限制 |
| video_generation_status | TINYINT(1) | NULL | 1 | 生视频状态：0-不可用，1-可用，2-速率限制 |
| image_count | INT | NULL | 0 | 图片生成次数 |
| video_count | INT | NULL | 0 | 视频生成次数 |
| image_unavailable_time | TIMESTAMP | NULL | - | 生图失效时间，当生图状态变为不可用时记录，用于额度刷新时恢复状态 |
| video_unavailable_time | TIMESTAMP | NULL | - | 生视频失效时间，当生视频状态变为不可用时记录，用于额度刷新时恢复状态 |
| quota_reset_time | TIMESTAMP | NULL | - | 额度重置时间，由应用在账号创建时写入“创建日期+1天的0:30”，并在隔天刷新账号为可用状态时更新；数据库不再自动使用当前时间 |
| priority | INT | NULL | 0 | 账号优先级 |
| max_retry_count | INT | NULL | 6 | 最大重试次数 |
| version | INT | NULL | 1 | 版本号 |
| is_deleted | TINYINT(1) | NULL | 0 | 逻辑删除标记 |
| create_time | TIMESTAMP | NULL | CURRENT_TIMESTAMP | 创建时间 |
| update_time | TIMESTAMP | NULL | CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |
| create_by | VARCHAR(50) | NULL | - | 创建人 |
| update_by | VARCHAR(50) | NULL | - | 修改人 |
| attr1 | VARCHAR(255) | NULL | - | 扩展字段1 |
| attr2 | VARCHAR(255) | NULL | - | 扩展字段2 |
| attr3 | TEXT | NULL | - | 扩展字段3 |

**索引：**
- PRIMARY KEY: id
- UNIQUE KEY: uk_session_site (session_id, site_type)
- INDEX: idx_account_status (account_status)
- INDEX: idx_generation_status (image_generation_status, video_generation_status)
- INDEX: idx_priority_create_time (priority DESC, create_time DESC)

---

### 表2：jimeng_image_generation_records（图片生成任务记录表）

| 字段名 | 数据类型 | 是否为空 | 默认值 | 说明 |
|--------|---------|---------|--------|------|
| id | VARCHAR(36) | NOT NULL | - | 主键，雪花UUID |
| jimeng_accounts_id | VARCHAR(36) | NOT NULL | - | 即梦账号表ID，逻辑外键不建立外键索引 |
| project_id | VARCHAR(50) | NOT NULL | - | 推理项目ID |
| project_name | VARCHAR(50) | NOT NULL | - | 推理项目名称 |
| storyboard_id | VARCHAR(50) | NOT NULL | - | 分镜ID |
| work_id | VARCHAR(50) | NOT NULL | - | 作品ID |
| model | VARCHAR(50) | NOT NULL | - | 使用的模型 |
| prompt | TEXT | NOT NULL | - | 生成提示词 |
| negative_prompt | TEXT | NULL | - | 负面提示词 |
| ratio | VARCHAR(10) | NULL | '1:1' | 宽高比，支持：1:1, 4:3, 3:4, 16:9, 9:16, 3:2, 2:3, 21:9 |
| resolution | VARCHAR(10) | NULL | '2k' | 分辨率，支持：1k, 2k, 4k |
| intelligent_ratio | TINYINT(1) | NULL | 0 | 是否启用智能比例，0-否，1-是，仅对jimeng-4.0/jimeng-4.1/jimeng-4.5模型有效 |
| sample_strength | DECIMAL(3,2) | NULL | - | 采样强度，范围0.0-1.0 |
| response_format | VARCHAR(20) | NULL | 'url' | 响应格式，url或b64_json |
| input_images | JSON | NULL | - | 输入图片URLs数组（图生图时使用） |
| original_session_id | VARCHAR(200) | NULL | - | 原始session_id |
| site_used | TINYINT(1) | NULL | - | 实际使用的站点：0-cn，1-us，2-hk，3-jp，4-sg |
| generation_status | TINYINT(1) | NULL | 0 | 生成状态：0-pending，1-processing，2-completed，3-failed，4-retrying |
| image_urls | JSON | NULL | - | 生成图片URL数组 |
| image_local_paths | JSON | NULL | - | 图片本地路径数组 |
| generation_time | INT | NULL | - | 生成耗时(秒) |
| error_code | VARCHAR(20) | NULL | - | 错误码 |
| error_message | TEXT | NULL | - | 错误信息 |
| site_switch_count | INT | NULL | 0 | 站点切换次数 |
| priority | INT | NULL | 0 | 任务优先级 |
| callback_url | VARCHAR(500) | NULL | - | 回调地址 |
| version | INT | NULL | 1 | 版本号 |
| is_deleted | TINYINT(1) | NULL | 0 | 逻辑删除标记 |
| create_time | TIMESTAMP | NULL | CURRENT_TIMESTAMP | 创建时间 |
| update_time | TIMESTAMP | NULL | CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |
| create_by | VARCHAR(50) | NULL | - | 创建人 |
| update_by | VARCHAR(50) | NULL | - | 修改人 |
| attr1 | VARCHAR(255) | NULL | - | 扩展字段1 |
| attr2 | VARCHAR(255) | NULL | - | 扩展字段2 |
| attr3 | TEXT | NULL | - | 扩展字段3 |

**索引：**
- PRIMARY KEY: id
- UNIQUE KEY: uk_project_storyboard (project_id, storyboard_id, is_deleted)
- INDEX: idx_jimeng_accounts_id_status (jimeng_accounts_id, generation_status)
- INDEX: idx_project_storyboard (project_id, storyboard_id)
- INDEX: idx_status_create_time (generation_status, create_time)

> 说明：`jimeng_accounts_id` 为逻辑外键，数据库层面不建立真实 FOREIGN KEY 约束，由应用程序保证与 `jimeng_accounts(id)` 的关联一致性。

---

### 表3：jimeng_video_generation_records（视频生成任务记录表）

| 字段名 | 数据类型 | 是否为空 | 默认值 | 说明 |
|--------|---------|---------|--------|------|
| id | VARCHAR(36) | NOT NULL | - | 主键，雪花UUID |
| jimeng_accounts_id | VARCHAR(36) | NOT NULL | - | 即梦账号表ID，逻辑外键不建立外键索引 |
| project_id | VARCHAR(50) | NOT NULL | - | 推理项目ID |
| project_name | VARCHAR(50) | NOT NULL | - | 推理项目名称 |
| storyboard_id | VARCHAR(50) | NOT NULL | - | 分镜ID |
| work_id | VARCHAR(50) | NOT NULL | - | 作品ID |
| model | VARCHAR(50) | NOT NULL | - | 使用的模型 |
| prompt | TEXT | NOT NULL | - | 生成提示词 |
| negative_prompt | TEXT | NULL | - | 负面提示词 |
| ratio | VARCHAR(10) | NULL | '16:9' | 宽高比，支持：1:1, 4:3, 3:4, 16:9, 9:16, 21:9（图生视频时此参数会被忽略） |
| resolution | VARCHAR(10) | NULL | '720p' | 视频分辨率，支持：720p, 1080p |
| duration | INT | NULL | 5 | 视频时长(秒)，支持：5, 10 |
| response_format | VARCHAR(20) | NULL | 'url' | 响应格式，url或b64_json |
| input_images | JSON | NULL | - | 输入图片URLs数组(图生视频或首尾帧视频) |
| original_session_id | VARCHAR(200) | NULL | - | 原始session_id |
| site_used | TINYINT(1) | NULL | - | 实际使用的站点：0-cn，1-us，2-hk，3-jp，4-sg |
| generation_status | TINYINT(1) | NULL | 0 | 生成状态：0-pending，1-processing，2-completed，3-failed，4-retrying |
| remote_task_id | VARCHAR(100) | NULL | - | 远程任务ID |
| video_urls | JSON | NULL | - | 生成视频URL数组 |
| video_local_paths | JSON | NULL | - | 视频本地路径数组 |
| generation_time | INT | NULL | - | 生成耗时(秒) |
| error_code | VARCHAR(20) | NULL | - | 错误码 |
| error_message | TEXT | NULL | - | 错误信息 |
| site_switch_count | INT | NULL | 0 | 站点切换次数 |
| priority | INT | NULL | 0 | 任务优先级 |
| callback_url | VARCHAR(500) | NULL | - | 回调地址 |
| version | INT | NULL | 1 | 版本号 |
| is_deleted | TINYINT(1) | NULL | 0 | 逻辑删除标记 |
| create_time | TIMESTAMP | NULL | CURRENT_TIMESTAMP | 创建时间 |
| update_time | TIMESTAMP | NULL | CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |
| create_by | VARCHAR(50) | NULL | - | 创建人 |
| update_by | VARCHAR(50) | NULL | - | 修改人 |
| attr1 | VARCHAR(255) | NULL | - | 扩展字段1 |
| attr2 | VARCHAR(255) | NULL | - | 扩展字段2 |
| attr3 | TEXT | NULL | - | 扩展字段3 |

**索引：**
- PRIMARY KEY: id
- UNIQUE KEY: uk_project_storyboard (project_id, storyboard_id, is_deleted)
- INDEX: idx_jimeng_accounts_id_status (jimeng_accounts_id, generation_status)
- INDEX: idx_project_storyboard (project_id, storyboard_id)
- INDEX: idx_status_create_time (generation_status, create_time)
- INDEX: idx_remote_task_id (remote_task_id)